from os import listdir
from os.path import isfile
from os.path import abspath
from os.path import dirname
from os.path import sep
from os.path import basename
from prompt_toolkit.completion import NestedCompleter
from prompt_toolkit.styles import Style
from prompt_toolkit import PromptSession
from prompt_toolkit.history import InMemoryHistory
from prompt_toolkit.auto_suggest import AutoSuggestFromHistory
from inspect import getmembers
from inspect import isclass
from imp import load_source
from .base import Exploit
from sys import exit
from tabulate import tabulate
from subprocess import run as sh

class cli:
    _help_ = {
        "help": "show this help menu",
        "show": "show all available exploits",
        "select": "select an exploit",
        "sh": "run shell command on local system",
        "cls": "clear screen",
        "back": "go back to previous menu",
        "exit": "exit program"
    }

    def __init__(self):
        self.exploits_path = dirname(abspath(__file__)).replace("/internal", "")
        self.exploits = [f.rstrip(".py")
                    for i, f in enumerate(listdir(self.exploits_path))
                    if isfile(f"{self.exploits_path}{sep}{f}")
                    and f not in (basename(__file__), "base.py")]
        self.style = Style.from_dict({
            "prompt": "#ff0000"
        })

    def show(self):
        print("Exploits:")
        for exploit in self.exploits:
            print(f"\t\u2022 {exploit}")
        print()

    def select(self, exploit):
        mod = __import__(f"modules.exploits.{exploit}", fromlist=["exp"])
        exploit_class = [c for (_,c) in getmembers(mod, isclass)
                        if issubclass(c, Exploit) & (c is not Exploit)][0]
        return self.exploit_prompt(exploit_class())

    def exploit_prompt(self, cls):
        exploit_args_dict = {arg: None
                for arg in cls.args.keys()}
        exploit_menu_dict = {
            "help": None,
            "show": None,
            "info": None,
            "set": exploit_args_dict,
            "unset": exploit_args_dict,
            "sh": None,
            "run": None,
            "cls": None,
            "back": None,
            "exit": None
        }

        exploits_help_menu = {
            "help": "show this help message",
            "show": "show the current state of exploit arguments",
            "info": "show general exploit information",
            "set": "set value",
            "unset": "unset value",
            "sh": "run shell command on local system",
            "run": "run exploit",
            "cls": "clear screen",
            "back": "go back to previous menu",
            "exit": "exit program"
        }

        exploit_menu = NestedCompleter.from_nested_dict(exploit_menu_dict)
        message = [("class:prompt", cls.prompt)]
        while True:
            try:
                selected = self.session.prompt(
                    message,
                    style=self.style,
                    completer=exploit_menu,
                    complete_while_typing=False
                ).strip()
            except KeyboardInterrupt:
                print("Press [CTRL+D] to exit")
                continue
            except EOFError:
                print("❌❌❌ Goodbye ❌❌❌")
                exit(1)

            if selected == "help":
                table = tabulate(
                        [[k, v] for k, v in exploits_help_menu.items()],
                        headers=["Command", "Description"],
                        tablefmt="fancy_grid")
                print(table)
            elif selected == "show":
                table = tabulate(
                        [[arg, cls.__dict__[arg]] for arg in cls.args.keys()],
                        headers=["Argument", "Value"],
                        tablefmt="fancy_grid")
                print(table)
            elif selected == "info":
                table = tabulate([[k, v] for k, v in cls.info.items()],
                        headers=["Key", "Value"],
                        tablefmt="fancy_grid")
                print(table)
            elif selected.startswith("unset"):
                cls.__dict__[select.split()[-1].strip()] = ""
            elif selected.startswith("set"):
                selected = selected.split()
                if len(selected) < 2:
                    print("the `set` command must be proceeded with an argument and value")
                    print("\nexample:\n\tset url http://localhost:8080")
                    continue
                arg, val = selected[1].strip(), " ".join(selected[2:])
                cls.__dict__[arg] = val
            elif selected == "run":
                try:
                    cls.run()
                except NotImplementedError:
                    print("[X] This exploits `run` function has not been implemented")
            elif selected.startswith("sh "):
                cmd = selected.split()[1:]
                if cmd:
                    try:
                        out = sh(cmd, capture_output=True).stdout
                    except:
                        cmd = ' '.join(cmd)
                        print(f"unable to run command: `{cmd}`")
                        continue
                    print(out.decode("utf8"))
                else: print("`sh` command used but no shell command was specified")
            elif selected == "cls":
                print("\n"*75)
            elif selected == "back":
                break
            elif selected == "exit":
                print("❌❌❌ Goodbye ❌❌❌")
                exit(0)
            else:
                print(f"`{selected}` is not a valid command! Type `help` for help menu")

    def help(self):
        print(self._help_)

    def init(self):
        menu = NestedCompleter.from_nested_dict({
            "help": None,
            "show": None,
            "select": {exploit: None for exploit in self.exploits},
            "sh": None,
            "cls": None,
            "back": None,
            "exit": None
        })

        self.session = PromptSession(
                complete_while_typing=False,
                auto_suggest=AutoSuggestFromHistory()
        )
        message = [("class:prompt", "〔Exploits〕❯ ")]
        while True:
            try:
                selected = self.session.prompt(
                    message,
                    style=self.style,
                    completer=menu,
                ).strip()
            except KeyboardInterrupt:
                print("Press [CTRL+D] to exit")
                continue
            except EOFError:
                print("❌❌❌ Goodbye ❌❌❌")
                exit(1)

            if selected == "show":
                self.show()
            elif selected.startswith("select"):
                selected = selected.split()
                if len(selected) == 1 or selected[-1] == "":
                    print("Must provide an exploit by name to use, try `show` command")
                    continue
                exploit = selected[-1].strip()
                if exploit not in self.exploits:
                    print(f"{exploit} is not a valid exploit, try `show` command")
                    continue
                self.select(exploit)
            elif selected == "help":
                table = tabulate([[k, v] for k, v in self._help_.items()],
                        headers=["Command", "Description"],
                        tablefmt="fancy_grid")
                print(table)
            elif selected.startswith("sh"):
                cmd = selected.split()[1:]
                if cmd:
                    try:
                        out = sh(cmd, capture_output=True).stdout
                    except:
                        cmd = ' '.join(cmd)
                        print(f"unable to run command: `{cmd}`")
                        continue
                    print(out.decode("utf8"))
                else: print("`sh` command used but no shell command was specified")
            elif selected == "cls":
                print("\n"*75)
            elif selected in ("back"):
                break
            elif selected == "exit":
                print("❌❌❌ Goodbye ❌❌❌")
                exit(0)
            else:
                print(f"`{selected}` is not a valid command! Type `help` for help menu")
